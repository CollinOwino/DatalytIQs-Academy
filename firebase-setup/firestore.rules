rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- helper function ---------- */
    function isSignedIn() {
      return request.auth != null;
    }
    function isAdmin() {
      // add custom claim "role":"admin" via Firebase Admin SDK
      return isSignedIn() && request.auth.token.role == "admin";
    }

    /* ---------- users collection ---------- */
    match /users/{uid} {
      allow read, write: if isSignedIn() && request.auth.uid == uid;
    }

    /* ---------- quiz responses ---------- */
    match /quizResponses/{responseId} {
      // Only allow the owner to read/write their own response
      allow read, write: if isSignedIn() && request.auth.uid == request.resource.data.uid;
      
      // Prevent overwrite by others
      allow update, delete: if false;
    }

    /* ---------- classes (videos, metadata) ---------- */
    match /classes/{classId} {
      // Everyone can read published classes
      allow read: if true;

      // Only admins can create/update/delete classes
      allow write: if isAdmin();
    }

    /* ---------- fallback deny ---------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
